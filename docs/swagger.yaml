swagger: "2.0"
info:
  description: "Cortex exposes an asynchronous network reconnaissance pipeline that decouples request admission from long-running probe execution. Clients describe a scan once, receive a UUID acknowledging queue placement, and then poll for progress until workers deposit structured results.\nThe workflow follows three simple steps:\n1. Submit POST /scans with hosts, ports, and the probing mode best suited for the job.\n2. Store the returned identifier and periodically call GET /scans/{id} to observe lifecycle transitions from pending → running → completed (or failed).\n3. When the task reaches completed the response includes normalized port findings; failed states surface a diagnostic error message.\nEvery request—except for the interactive Swagger UI under /docs—must present the configured API key using the Authorization: Bearer <token> header. Missing or invalid credentials are rejected before any work begins."
  title: "Cortex API"
  termsOfService: "http://swagger.io/terms/"
  contact:
    email: "support@swagger.io"
    name: "API Support"
    url: "http://www.swagger.io/support"
  license:
    name: "MIT"
    url: "https://opensource.org/licenses/MIT"
  version: "5.0"
host: "localhost:8080"
basePath: "/api/v1"
schemes:
  - "http"
paths:
  /scans:
    post:
      consumes:
        - "application/json"
      produces:
        - "application/json"
      summary: "Create a new scan task"
      description: "Submit a scan definition and let Cortex execute it asynchronously. The handler validates input, persists the task, and enqueues it for background workers before returning a UUID.\n\n**Lifecycle**: POST /scans immediately answers with HTTP 202 Accepted plus the task identifier. Clients must poll GET /scans/{id} to observe status transitions (pending → running → completed/failed). Actual port findings are attached only after completion.\n\n**Common pitfalls**: malformed JSON, unsupported modes, or exceeding rate limits will return structured error responses containing a human-readable explanation."
      operationId: "createScan"
      tags:
        - "Scans"
      security:
        -
          ApiKeyAuth: []
      parameters:
        -
          description: "Scan request parameters"
          name: "scanRequest"
          in: "body"
          required: true
          schema:
            $ref: "#/definitions/CreateScanRequest"
      responses:
        202:
          description: "Scan accepted. Poll GET /scans/{id} to track progress."
          schema:
            $ref: "#/definitions/ScanAcceptedResponse"
          examples:
            application/json:
              id: "a3f5c62e-1234-4f72-a84a-1c2d3e4f5678"
              status: "pending"
        400:
          description: "Malformed JSON body or failed validation."
          schema:
            $ref: "#/definitions/ErrorResponse"
          examples:
            application/json:
              error: "invalid request payload: validation failed on 'mode'"
        401:
          description: "Missing or incorrect API key."
          schema:
            $ref: "#/definitions/ErrorResponse"
          examples:
            application/json:
              error: "unauthorized"
        429:
          description: "Rate limit exceeded for the calling client."
          schema:
            $ref: "#/definitions/ErrorResponse"
          examples:
            application/json:
              error: "rate limit exceeded"
        500:
          description: "Internal error while persisting or queueing the task."
          schema:
            $ref: "#/definitions/ErrorResponse"
          examples:
            application/json:
              error: "failed to queue task"
  /scans/{id}:
    get:
      produces:
        - "application/json"
      summary: "Get scan status and results"
      description: "Retrieve a live snapshot of a scan task. Supply the UUID obtained from POST /scans and poll this endpoint until the lifecycle reaches completed.\n\n**Polling guidance**: responses with status pending or running will include metadata but results remains empty. Once the task is completed, results contains every observed port state and optional service fingerprints. If the task fails, the error field clarifies the reason.\n\n**Error handling**: invalid UUIDs, missing authorization, rate limiting, or unknown tasks all return structured ErrorResponse payloads so clients can adjust behavior programmatically."
      operationId: "getScan"
      tags:
        - "Scans"
      security:
        -
          ApiKeyAuth: []
      parameters:
        -
          type: "string"
          description: "Scan Task ID (UUID v4)"
          name: "id"
          in: "path"
          required: true
      responses:
        200:
          description: "Current task snapshot including results when completed."
          schema:
            $ref: "#/definitions/ScanTask"
          examples:
            application/json:
              id: "a3f5c62e-1234-4f72-a84a-1c2d3e4f5678"
              status: "completed"
              results:
                -
                  host: "scanme.nmap.org"
                  port: 443
                  state: "Open"
                  service: "https"
        400:
          description: "Malformed task identifier."
          schema:
            $ref: "#/definitions/ErrorResponse"
          examples:
            application/json:
              error: "invalid task id format"
        401:
          description: "Missing or incorrect API key."
          schema:
            $ref: "#/definitions/ErrorResponse"
          examples:
            application/json:
              error: "unauthorized"
        404:
          description: "Task with the provided ID does not exist."
          schema:
            $ref: "#/definitions/ErrorResponse"
          examples:
            application/json:
              error: "task not found"
        429:
          description: "Rate limit exceeded for the calling client."
          schema:
            $ref: "#/definitions/ErrorResponse"
          examples:
            application/json:
              error: "rate limit exceeded"
        500:
          description: "Internal error when loading the task."
          schema:
            $ref: "#/definitions/ErrorResponse"
          examples:
            application/json:
              error: "failed to load task"
securityDefinitions:
  ApiKeyAuth:
    type: "apiKey"
    name: "Authorization"
    in: "header"
    description: "Supply the configured API key using the Authorization: Bearer <token> header."
definitions:
  CreateScanRequest:
    type: "object"
    required:
      - "hosts"
      - "mode"
      - "ports"
    properties:
      hosts:
        type: "array"
        description: "Targets to scan. Accepts IPv4/IPv6 addresses and domain names that resolve via DNS. Provide at least one entry; multiple hosts are processed concurrently."
        items:
          type: "string"
        example:
          - "scanme.nmap.org"
          - "203.0.113.50"
      mode:
        type: "string"
        description: "Scanning strategy. connect performs TCP connect() handshakes suitable for banner grabbing, syn uses half-open SYN probes for fast TCP discovery, udp sends UDP payloads to uncover datagram services."
        enum:
          - "connect"
          - "syn"
          - "udp"
        example: "connect"
      ports:
        type: "string"
        description: "Combination of single ports and inclusive ranges (e.g. 80,443,1000-1050). Leave no spaces for best readability; ranges must use a hyphen."
        example: "443,8443,10000-10100"
    additionalProperties: false
  ErrorResponse:
    type: "object"
    properties:
      error:
        type: "string"
        description: "Human readable error message describing why the request was rejected. The value is localized for operators rather than end users."
        example: "task not found"
    additionalProperties: false
  ScanAcceptedResponse:
    type: "object"
    properties:
      id:
        type: "string"
        description: "Identifier clients must supply to GET /scans/{id} when polling for status."
        example: "a3f5c62e-1234-4f72-a84a-1c2d3e4f5678"
        format: "uuid"
      status:
        type: "string"
        description: "Initial queue state assigned to every newly accepted scan request."
        enum:
          - "pending"
        example: "pending"
    additionalProperties: false
  ScanResult:
    type: "object"
    properties:
      host:
        type: "string"
        description: "Target host that produced the observation. Mirrors the input host field so clients can join results back to their original request."
        example: "scanme.nmap.org"
      port:
        type: "integer"
        format: "int32"
        description: "Network port that was probed. Expressed as an integer in the 0-65535 range."
        example: 443
      service:
        type: "string"
        description: "Optional service fingerprint (if detected) describing application protocol and banner. Empty when the probe could not identify an application."
        example: "http (nginx)"
        x-nullable: true
      state:
        type: "string"
        description: "Resulting port disposition derived from worker probes. Open indicates a responsive service, Closed means the port rejected connections, and Filtered signifies intermediary packet filtering."
        enum:
          - "Open"
          - "Closed"
          - "Filtered"
        example: "Open"
    additionalProperties: false
  ScanTask:
    type: "object"
    properties:
      completed_at:
        type: "string"
        format: "date-time"
        description: "Timestamp (UTC, RFC3339 format) indicating when the task finished processing. Empty while the task is pending or running."
        example: "2024-01-02T15:06:30Z"
      created_at:
        type: "string"
        format: "date-time"
        description: "Timestamp (UTC, RFC3339 format) when the API accepted the scan request."
        example: "2024-01-02T15:04:05Z"
      error:
        type: "string"
        description: "Diagnostic message describing why the task entered the failed status. Present only when status equals failed."
        example: "failed to resolve target host"
      hosts:
        type: "array"
        description: "List of destination targets. Supports IPv4/IPv6 literals and resolvable domain names. The order is preserved so results can be mapped back to the original submission."
        items:
          type: "string"
        example:
          - "scanme.nmap.org"
          - "192.0.2.10"
      id:
        type: "string"
        description: "Immutable UUIDv4 identifier assigned when the task is accepted. Persist this value and reuse it for subsequent polling requests."
        example: "a3f5c62e-1234-4f72-a84a-1c2d3e4f5678"
        format: "uuid"
      mode:
        type: "string"
        description: "Scanner transport mode. Use connect for TCP connect() handshakes, syn for half-open SYN scanning against TCP endpoints, or udp for stateless UDP datagram probes."
        enum:
          - "connect"
          - "syn"
          - "udp"
        example: "syn"
      ports:
        type: "string"
        description: "Port expression combining single ports and inclusive ranges using commas (for example 22,80,443,1000-1100). Whitespace is ignored and duplicate ports are automatically de-duplicated by the scheduler."
        example: "22,80,443,1000-1100"
      results:
        type: "array"
        description: "Collection of port states collected during scanning. Present only after the task reaches the completed status. The array is sorted by host then port for easy rendering."
        items:
          $ref: "#/definitions/ScanResult"
        example:
          -
            host: "scanme.nmap.org"
            port: 443
            state: "Open"
            service: "https"
      status:
        type: "string"
        description: "Current processing state. pending indicates the request is queued, running signals active probing, completed denotes success with results attached, and failed highlights an unrecoverable worker-side issue."
        enum:
          - "pending"
          - "running"
          - "completed"
          - "failed"
        example: "pending"
    additionalProperties: false
tags:
  -
    name: "Scans"
    description: "Cortex orchestrates distributed port scans. Submit new jobs, inspect intermediate task state, and retrieve final findings from this tag."
